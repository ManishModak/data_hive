var t=Object.defineProperty,e=(e,r,a)=>((e,r,a)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[r]=a)(e,"symbol"!=typeof r?r+"":r,a);!function(){try{var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},e=(new t.Error).stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="2631ab28-36e0-47a7-902b-fc0b02a5311b",t._sentryDebugIdIdentifier="sentry-dbid-2631ab28-36e0-47a7-902b-fc0b02a5311b")}catch(r){}}();import{B as r}from"./messenger-Bd6yZOQZ.js";import{R as a}from"./types-Oyjdt06n.js";const n="function"==typeof r;"function"==typeof TextDecoder&&new TextDecoder;const s="function"==typeof TextEncoder?new TextEncoder:void 0,o=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=");(()=>{let t={};o.forEach(((e,r)=>t[e]=r))})();const i=String.fromCharCode.bind(String);"function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array);const c="function"==typeof btoa?t=>btoa(t):n?t=>r.from(t,"binary").toString("base64"):t=>{let e,r,a,n,s="";const i=t.length%3;for(let c=0;c<t.length;){if((r=t.charCodeAt(c++))>255||(a=t.charCodeAt(c++))>255||(n=t.charCodeAt(c++))>255)throw new TypeError("invalid character found");e=r<<16|a<<8|n,s+=o[e>>18&63]+o[e>>12&63]+o[e>>6&63]+o[63&e]}return i?s.slice(0,i-3)+"===".substring(i):s},l=n?t=>r.from(t).toString("base64"):t=>{let e=[];for(let r=0,a=t.length;r<a;r+=4096)e.push(i.apply(null,t.subarray(r,r+4096)));return c(e.join(""))},u=t=>{if(t.length<2)return(e=t.charCodeAt(0))<128?t:e<2048?i(192|e>>>6)+i(128|63&e):i(224|e>>>12&15)+i(128|e>>>6&63)+i(128|63&e);var e=65536+1024*(t.charCodeAt(0)-55296)+(t.charCodeAt(1)-56320);return i(240|e>>>18&7)+i(128|e>>>12&63)+i(128|e>>>6&63)+i(128|63&e)},h=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,p=n?t=>r.from(t,"utf8").toString("base64"):s?t=>l(s.encode(t)):t=>c(t.replace(h,u)),d=(t,e=!1)=>e?(t=>t.replace(/=/g,"").replace(/[+\/]/g,(t=>"+"==t?"-":"_")))(p(t)):p(t);class f extends Error{constructor(t,r,a){super(t),e(this,"code"),e(this,"context"),e(this,"cause"),this.cause=null==a?void 0:a.cause,this.code=r,this.context=null==a?void 0:a.context}toJSON(){return{message:this.message,code:this.code,context:this.context}}}class x extends f{constructor(t,e,r){super(t,"extraction/captcha",{context:{html:e,detections:r}})}}var m,R,y,E;(R=m||(m={})).HTML_EMPTY="extraction/html-empty",R.PLAINTEXT_EMPTY="extraction/plaintext-empty",R.EXTRACTING_ERROR="extraction/extract-error";class T extends f{constructor(t,e,r){super(t,e,{context:{html:r}})}}function g(t,e){return r=function(t){const e="string"==typeof t?t:t.textContent;if(!e)return null;try{return JSON.parse(e)}catch{return null}}(t),(a=e.path)&&null!=r?(a.match(/(\w+|\[\d+\]|\[['"][^'"\]]+['"]\])/g)||[]).reduce(((t,e)=>{if(null!=t)return t[e.startsWith("[")?e.replace(/^\[['"]?|['"]?\]$/g,""):e]}),r):r;var r,a}class w{constructor(t,r){e(this,"nodeExtractor"),e(this,"adapter"),this.nodeExtractor=t,this.adapter=r}detect(t){const e=[];for(const r of t){const{xpath:t,match:a,is_positive:n}=r,s=!!t&&this.nodeExistsByXpath(t);if(!a){s===n&&e.push(r);continue}const o=t&&s?this.extractNodeHtmlByXpath(t):this.adapter.extractHtml();if(!o)continue;!!o.match(a)===n&&e.push(r)}return e}nodeExistsByXpath(t){const e=this.adapter.getDocument();return!!this.nodeExtractor.extractNode(t,e)}extractNodeHtmlByXpath(t){const e=this.adapter.getDocument(),r=this.nodeExtractor.extractNode(t,e);if(!r)return"";if("string"==typeof r)return r;return(Array.isArray(r)?r:[r]).map((t=>this.nodeExtractor.extractNodeTextContent(t))).join("")}}class b{constructor(t){e(this,"adapter"),this.adapter=t}extractNode(t,e,r=!1){if(t.startsWith("normalize-space(")||t.startsWith("string(")||t.startsWith("concat(")){return this.adapter.evaluateXPath(t,e,this.adapter.STRING_TYPE).stringValue||null}const a=this.adapter.evaluateXPath(t,e,r?this.adapter.ORDERED_NODE_SNAPSHOT_TYPE:this.adapter.FIRST_ORDERED_NODE_TYPE);if(r){const t=[];for(let e=0;e<a.snapshotLength;e++){const r=a.snapshotItem(e);r&&t.push(r)}return t}return a.singleNodeValue}extractNodeTextContent(t){var e;if(!t)return null;if("script"===(null==(e=t.getUnderlyingNode().nodeName)?void 0:e.toLowerCase()))return t.textContent||null;if(t.textContent&&!t.evaluate(".//text()",this.adapter.ORDERED_NODE_SNAPSHOT_TYPE).snapshotLength)return t.textContent;const r=t.evaluate(".//text()[not(ancestor::script) and not(ancestor::style)]",this.adapter.ORDERED_NODE_SNAPSHOT_TYPE),a=[];for(let n=0;n<r.snapshotLength;n++){const t=r.snapshotItem(n);(null==t?void 0:t.textContent)&&a.push(t.textContent)}return a.join(" ").replace(/\s+/g," ").trim()||null}}(E=y||(y={})).TIMEOUT="extraction/element-wait-timeout",E.NOT_FOUND="extraction/element-not-found";class N extends f{constructor(t,e,r,a,n){super(t,e,{context:{xpath:r,timeout:n,html:a}})}}class O extends f{constructor(t,e){super(`Invalid URL provided: ${t}${e?`. ${e}`:""}`,"extraction/invalid-url",{context:{url:t}})}}function A(t){try{return new URL(t)}catch(e){throw new O(t)}}function C(t){return!t||""===t.trim()||(t.startsWith("javascript:")||t.startsWith("mailto:")||t.startsWith("tel:")||"#"===t||t.startsWith("#"))}function _(t,e={}){const r=new URL(t.href);return e.removeHash&&(r.hash=""),e.removeSearch&&(r.search=""),r.toString()}function D(t,e){try{return t.match(/^https?:\/\//i)?new URL(t):new URL(t,e)}catch(r){return null}}class P{constructor(t){e(this,"adapter"),e(this,"nodeExtractor"),e(this,"captchaDetector"),this.adapter=t,this.nodeExtractor=new b(t),this.captchaDetector=new w(this.nodeExtractor,t)}static hasCaptcha(t,e){if(!t)return!1;if(!e)return!1;const{positive:r,negative:a}=e;return!(!r||!t.match(r))||!(!a||t.match(a))}async extractDataByRulesWithCaptchaCheck(t){if(await this.adapter.waitForPageLoad(),t.wait&&await this.adapter.waitForElement(t.wait.xpath,t.wait.timeout),t.captchas){const e=this.captchaDetector.detect(t.captchas);if(e.length>0){const t=this.adapter.extractHtml();throw new x("Captcha detected",d(t),e)}}else if(t.captcha){const e=this.adapter.extractHtml();if(P.hasCaptcha(e,t.captcha))throw new x("Captcha detected",d(e))}return this.extractDataByRules(t)}extractDataByRules(t){const e={fields:this.evaluateRules(t.fields,this.adapter.getDocument())};if(t.html){const t=this.adapter.extractHtml();if(!t)throw new T("Required HTML content is empty",m.HTML_EMPTY);e.html=d(t)}if(t.plaintext){const t=this.adapter.extractPlainText();if(!t)throw new T("Required plaintext content is empty",m.PLAINTEXT_EMPTY,d(this.adapter.extractHtml()));e.plaintext=d(t)}if(t.urls){const t=this.adapter.extractUrls();t&&(e.urls=t)}return e}evaluateRules(t,e){const r={};if(!Array.isArray(t))return r;for(const a of t){const t=this.isObjectsRule(a)||this.isPropertiesRule(a),n=this.extractNode(a.xpath,e,t);if(this.isPropertyRule(a)){if(Array.isArray(n))throw new T("Property rule cannot be applied to multiple nodes",m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));r[a.field_name]=n?this.processPropertyRule(n,a):""}else if(this.isObjectRule(a)){if(Array.isArray(n))throw new T("Property rule cannot be applied to multiple nodes",m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));r[a.field_name]=n?this.processObjectRule(n,a):{}}else if(this.isObjectsRule(a)){if(!Array.isArray(n))throw new T("Objects rule must be applied to multiple nodes",m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));r[a.field_name]=n?this.processObjectsRule(n,a):[]}else if(this.isPropertiesRule(a)){if(!Array.isArray(n))throw new T("Properties rule must be applied to multiple nodes",m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));r[a.field_name]=n?this.processPropertiesRule(n,a):[]}else{if(!this.isJSONRule(a))throw new T(`Unknown rule type: ${a.type}`,m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));if(Array.isArray(n))throw new T("JSON rule cannot be applied to multiple nodes",m.EXTRACTING_ERROR,d(this.adapter.extractHtml()));r[a.field_name]=n?this.processJSONRule(n,a):null}}return r}extractNode(t,e,r=!1){return this.nodeExtractor.extractNode(t,e,r)}extractNodeTextContent(t){return this.nodeExtractor.extractNodeTextContent(t)}extractAndFormatData(t,e,r){const a=t.trim().replace(/\s+/g," "),n=e.exec(a);if(!n)return null;const s=r.replace(/\\(\d+)/g,((t,e)=>{const r=Number.parseInt(e,10);return(n[r]||"").trim().replace(/\s+/g," ")}));return s===r?null:s}processPropertyRule(t,e){let r=null;if(r="string"==typeof t?t:this.extractNodeTextContent(t),!r)return"";if(!e.regexp||!e.template)return r;const a=new RegExp(e.regexp);return this.extractAndFormatData(r,a,e.template)||""}processObjectRule(t,e){if("string"==typeof t)throw new T("Object rule cannot be applied to string result",m.EXTRACTING_ERROR,d(t));return this.evaluateRules(e.child,t)}processObjectsRule(t,e){return t.map((t=>this.evaluateRules(e.child,t)))}processPropertiesRule(t,e){return t.map((t=>{const r=this.extractNodeTextContent(t);if(!r)return"";if(!e.regexp||!e.template)return r;const a=new RegExp(e.regexp);return this.extractAndFormatData(r,a,e.template)||""}))}processJSONRule(t,e){return g(t,e)}isPropertyRule(t){return t.type===a.PROPERTY}isObjectRule(t){return t.type===a.OBJECT}isObjectsRule(t){return t.type===a.OBJECTS}isPropertiesRule(t){return t.type===a.PROPERTIES}isJSONRule(t){return t.type===a.JSON}}const v=t=>new P(t);export{N as E,y as a,v as c,_ as n,D as r,C as s,A as v};
